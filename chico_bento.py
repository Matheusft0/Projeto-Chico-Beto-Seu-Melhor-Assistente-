# -*- coding: utf-8 -*-
"""CHICO BENTO

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1Sg6Yh_KO_zRAocgHG3rzrZ5EK8PqzZNV
"""

# 1. Instalar libs necess√°rias
!pip install -q gspread pandas google-genai
!pip install -U google-generativeai

# 2. Importar bibliotecas e autenticar (espec√≠fico para Google Colab)
import pandas as pd
import gspread
import os
from datetime import datetime
import re # Importando a biblioteca de express√µes regulares

# Bibliotecas para autentica√ß√£o e segredos no Google Colab
from google.colab import auth
from google.auth import default
from google.colab import userdata # Para acessar os 'secrets' do Colab

# Autentica√ß√£o do usu√°rio no Colab
try:
    auth.authenticate_user()
    creds, _ = default()
    gc = gspread.authorize(creds)
except Exception as e:
    print(f"Chico Beto: Ih, deu chabu na hora de conect√° com as planilha do Google, s√¥: {e}")
    print("Chico Beto: Quem cuida de mim precisa dar uma olhada nisso pra eu poder te ajudar.")
    exit()

# Carregar a planilha
# Substitua pelo ID da sua planilha. Certifique-se que ela existe e voc√™ tem acesso.
spreadsheet_id = "(ID) da sua Planilha" # MANTENHA O ID FORNECIDO PELO USU√ÅRIO
df = pd.DataFrame() # Inicializa df vazio para o caso de falha no carregamento

try:
    spreadsheet = gc.open_by_key(spreadsheet_id)
    sheet = spreadsheet.sheet1 # Assume que a primeira aba (sheet1) √© a desejada
    data = sheet.get_all_records(numericise_ignore=['Nota', 'Pre√ßo'])
    if data:
        df = pd.DataFrame(data)
        print("Chico Beto: √î trem b√£o! Meu caderninho de produto t√° carregado e pronto pra consulta, s√¥!")

        for col in ['Nome', 'Descri√ß√£o', 'Marca', 'Localiza√ß√£o']:
            if col in df.columns:
                df[col] = df[col].astype(str).str.strip()

        if 'Pre√ßo' in df.columns:
            df['Pre√ßo'] = df['Pre√ßo'].astype(str).str.replace('R$', '', regex=False).str.replace(',', '.', regex=False).str.strip()
            df['Pre√ßo'] = pd.to_numeric(df['Pre√ßo'], errors='coerce')

        if 'Nota' in df.columns:
            df['Nota'] = df['Nota'].astype(str).str.replace(',', '.', regex=False).str.strip()
            df['Nota'] = pd.to_numeric(df['Nota'], errors='coerce')

        if 'Quantidade' in df.columns:
            df['Quantidade'] = pd.to_numeric(df['Quantidade'], errors='coerce').fillna(0).astype(int)
    else:
        print("Chico Beto: Uai, parece que meu caderninho de produto t√° em branco ou deu chabu pra carregar.")
except gspread.exceptions.SpreadsheetNotFound:
    print(f"Chico Beto: Uai, num achei o caderninho com as anota√ß√£o (planilha com ID '{spreadsheet_id}'). Quem cuida de mim precisa conferir se o n√∫mero t√° certo e se eu posso bisbilhotar ela.")
    exit()
except Exception as e:
    print(f"Chico Beto: Uai, deu um revert√©rio aqui pra carregar meu caderninho de produto: {e}")
    exit()

# 3. Inicializar Google Gemini
import google.generativeai as genai

GOOGLE_API_KEY = None
try:
    GOOGLE_API_KEY = userdata.get('GOOGLE_API_KEY')
    genai.configure(api_key=GOOGLE_API_KEY)
except userdata.SecretNotFoundError:
    print("Chico Beto: Ih, cumpadi! Parece que o fio da minha sabedoria artifi√ß√° (API Key do Gemini) t√° desligado.")
    print("Chico Beto: Sem ela, num consigo te dar aquelas explica√ß√£o caprichada. Quem cuida de mim precisa dar um jeitinho nisso pra eu poder te ajudar com tudo, t√° bom?")
    exit()
except Exception as e:
    print(f"Chico Beto: Vixe Maria! Deu um pipoco aqui na hora de ligar minha sabedoria artifi√ß√°: {e}. Num vou conseguir te ajudar com as pergunta mais dif√≠cil hoje, s√¥.")
    exit()

MODEL_ID = "gemini-1.5-flash-latest"

# 4. Procurar produto na planilha
def buscar_produto(nome_produto_busca):
    if df.empty:
        return None

    if 'Nome' not in df.columns:
        print("Chico Beto: Ih, cumpadi, meu caderninho t√° esquisito, faltou a parte dos 'Nome' dos produto!")
        return None

    nome_lower = str(nome_produto_busca).lower().strip()
    if not nome_lower:
        return None

    nomes_planilha_lower = df['Nome'].astype(str).str.lower()
    resultados = df[nomes_planilha_lower.str.contains(nome_lower, na=False)]

    if resultados.empty:
        return None
    else:
        produtos_encontrados = []
        for _, linha in resultados.iterrows():
            produto_info = {
                "produto": linha.get('Nome', 'Nome n√£o dispon√≠vel'),
                "descricao": linha.get('Descri√ß√£o', 'Descri√ß√£o n√£o dispon√≠vel'),
                "marca": linha.get('Marca', 'Marca n√£o dispon√≠vel'),
                "preco": linha.get('Pre√ßo', 'Pre√ßo n√£o informado'),
                "nota": linha.get('Nota', 'Nota n√£o informada'),
                "quantidade": linha.get('Quantidade', 0),
                "localizacao": linha.get('Localiza√ß√£o', 'Localiza√ß√£o n√£o dispon√≠vel')
            }
            produtos_encontrados.append(produto_info)
        return produtos_encontrados

# 5. Salvar produto em falta direto na planilha
def salvar_faltantes_na_planilha(nome_produto_faltante):
    try:
        nome_aba_faltantes = "Faltantes"
        headers_faltantes = ["Produto", "Data"]

        try:
            aba_faltantes = spreadsheet.worksheet(nome_aba_faltantes)
        except gspread.exceptions.WorksheetNotFound:
            print(f"Chico Beto: Num achei a aba '{nome_aba_faltantes}' pra anotar os faltante, vou criar uma nova pra n√≥is...")
            aba_faltantes = spreadsheet.add_worksheet(title=nome_aba_faltantes, rows="1", cols=len(headers_faltantes))
            aba_faltantes.append_row(headers_faltantes)

        registros = aba_faltantes.get_all_records()
        nomes_existentes = []
        if registros:
            nomes_existentes = [str(registro.get("Produto", "")).lower() for registro in registros if registro.get("Produto")]

        if str(nome_produto_faltante).lower() not in nomes_existentes:
            data_atual = datetime.now().strftime("%d/%m/%Y %H:%M")
            aba_faltantes.append_row([nome_produto_faltante, data_atual])
            print(f"Chico Beto: Anotei '{nome_produto_faltante}' l√° na planilha dos faltantes, visse? Data: {data_atual}")
        else:
            print(f"Chico Beto: Esse '{nome_produto_faltante}' j√° tava anotado nos faltantes, uai!")
    except Exception as e:
        print(f"Chico Beto: Num consegui salvar o produto '{nome_produto_faltante}' nos faltantes n√£o, deu erro: {e}")

# Fun√ß√£o para extrair o nome do produto da pergunta do usu√°rio
def extrair_nome_produto_com_gemini(pergunta_cliente):
    try:
        prompt_extracao = (
            f"Analise a pergunta de um cliente de supermercado: '{pergunta_cliente}'. "
            f"Qual √© o nome do produto principal que o cliente est√° procurando? "
            f"Responda APENAS com o nome do produto. Por exemplo, se a pergunta for 'onde tem sab√£o em p√≥ azul da marca Xyz?', responda 'sab√£o em p√≥ azul da marca Xyz'. "
            f"Se for 'pre√ßo do caf√© torrado', responda 'caf√© torrado'. Se for 'biscoito', responda 'biscoito'."
            f"Se for 'tem p√£o?', responda 'p√£o'."
        )
        model_extracao = genai.GenerativeModel(MODEL_ID)
        response = model_extracao.generate_content(contents=prompt_extracao)
        if response and response.text:
            nome_produto_extraido = response.text.strip().replace('"', '').replace("'", "")
            return nome_produto_extraido
        else:
            print("Chico Beto: Hum, num t√¥ entendendo direitinho qual produto vosmec√™ qu√©... Pode explicar de novo?")
            return None
    except Exception as e:
        print(f"Chico Beto: Vixe! Deu um n√≥ na minha cabe√ßa tentando entender o produto. Tenta de novo, por favorzinho.")
        return None

# 6. Consultar rem√©dio ou produto com o Chico Bento (Gemini)
def consultar_produto_chico(descricao_usuario_original):
    print(f"Chico Beto: Deixa eu entend√™ o que vosmec√™ qu√© sab√™ sobre '{descricao_usuario_original}'...")
    nome_produto_foco = extrair_nome_produto_com_gemini(descricao_usuario_original)

    if not nome_produto_foco:
        return

    produto_encontrado_na_planilha = False
    resultados_planilha = None

    if not df.empty:
        print(f"\nChico Beto: Conferindo aqui no meu caderninho se tem '{nome_produto_foco}'...")
        print("\n")
        resultados_planilha = buscar_produto(nome_produto_foco)

        if resultados_planilha:
            produto_encontrado_na_planilha = True
            print(f"Chico Beto: √ìia s√≥ o que eu achei sobre '{nome_produto_foco}' aqui no estoque:")
            print("\n")
            for item in resultados_planilha:
                print(f"  -> Produto: {item['produto']}")
                if item['marca'] and str(item['marca']).lower() != 'marca n√£o dispon√≠vel':
                    print(f"     Marca: {item['marca']}")
                if item['descricao'] and str(item['descricao']).lower() != 'descri√ß√£o n√£o dispon√≠vel':
                    print(f"     O que √©: {item['descricao']}")

                preco_item = item.get('preco')
                if pd.notna(preco_item) and str(preco_item).lower() != 'pre√ßo n√£o informado':
                    try:
                        preco_formatado = f"{float(preco_item):.2f}".replace('.', ',')
                        print(f"     Quanto custa: R$ {preco_formatado}")
                    except (ValueError, TypeError):
                        print(f"     Quanto custa: {preco_item}")

                quantidade_item = item.get('quantidade', 0)
                try:
                    qtd_num = int(quantidade_item)
                    print(f"     Quantos tem no estoque: {qtd_num}")
                    if 0 <= qtd_num <= 10:
                        print("     Chico Beto Alerta: Corre que t√° acabando, s√¥!")
                except (ValueError, TypeError):
                    print(f"     Quantos tem no estoque: {quantidade_item} (num deu pra contar direito)")

                nota_item = item.get('nota')
                if pd.notna(nota_item) and str(nota_item).lower() != 'nota n√£o informada':
                    try:
                        nota_float = float(nota_item)
                        if nota_float > 5.0:
                            nota_float /= 10.0

                        nota_formatada = f"{nota_float:.1f}".replace('.', ',')
                        print(f"     Nota do povo: {nota_formatada} de 5 estrela")
                    except (ValueError, TypeError):
                         print(f"     Nota do povo: {nota_item}")

                if item['localizacao'] and str(item['localizacao']).lower() != 'localiza√ß√£o n√£o dispon√≠vel':
                    print(f"     Onde que t√° guardado: {item['localizacao']}")
                print("     --------------------")
        else:
            print(f"Chico Beto: Ih, '{nome_produto_foco}' num achei aqui no meu controle do armaz√©m n√£o, viu.")
    else:
        print("\nChico Beto: Meu caderninho de produto num t√° aqui ou t√° vazio, num consigo conferir o estoque, cumpadi.")

    # Consultar Gemini para informa√ß√µes adicionais
    print(f"\nChico Beto: Agora, deixa eu perguntar pra sabedoria artifi√ß√° sobre '{nome_produto_foco}'...")

    prompt_especifico_produto = ""
    e_cafe = "caf√©" in nome_produto_foco.lower()
    if not e_cafe and resultados_planilha:
        e_cafe = any("caf√©" in str(item['produto']).lower() for item in resultados_planilha)

    if e_cafe:
        prompt_especifico_produto = (
            f"Conte uma curiosidade bem da ro√ßa sobre caf√©, ou d√™ uma dica de como passar um caf√©zim b√£o que nem o da vov√≥. "
            f"Se o amigo perguntou sobre '{nome_produto_foco}', fale sobre ele primeiro, e depois emende com a dica ou causo do caf√©."
        )
    else:
        prompt_especifico_produto = (
            f"Fale mais sobre '{nome_produto_foco}', pra que serve, se √© b√£o mesmo, curiosidades ou dicas de uso."
        )

    prompt_chico = (
        f"Imagina que voc√™ √© o Chico Bento, um caipira muito gente boa e prestativo.\n"
        f"Um amigo seu perguntou sobre '{nome_produto_foco}'.\n"
        f"Se o item foi encontrado no estoque da loja (planilha), voc√™ j√° informou os detalhes do estoque (nome, marca, descri√ß√£o, pre√ßo, quantidade, nota, localiza√ß√£o) e se est√° acabando.\n"
        f"{prompt_especifico_produto}\n"
        f"Use um linguajar bem matuto, com express√µes t√≠picas, mas que seja f√°cil de entender e carinhoso.\n"
        f"Organize a resposta em t√≥picos simples. Para cada t√≥pico, comece com um emoji que combine com o assunto e com seu jeitinho caipira (por exemplo, ü§†, üëç, üí°, üòã, üåΩ, üëµ, ü§î), em vez de usar asteriscos ou negrito para destacar os t√≠tulos dos t√≥picos."
    )

    try:
        model_consulta = genai.GenerativeModel(MODEL_ID)
        response_consulta = model_consulta.generate_content(contents=prompt_chico)

        if response_consulta and response_consulta.text:
            # MODIFICA√á√ÉO AQUI: Remover os asteriscos (**) da prosa do Chico
            prosa_do_chico = response_consulta.text.replace('**', '')
            print("\n--- Prosa do Chico Bento (com uma ajudinha da intelig√™ncia artifi√ß√°) ---")
            print(prosa_do_chico) # Imprime a prosa j√° sem os asteriscos
            print("---------------------------------------------------------------------")
        else:
            print(f"Chico Beto: √ìia, procurei, procurei, mas num achei nada sobre '{nome_produto_foco}' pra te cont√° agora, s√¥.")
    except Exception as e:
        print(f"Chico Beto: Rapaz, deu um treco esquisito na hora de consultar a sabedoria artifi√ß√°: {e}")

    if not produto_encontrado_na_planilha and not df.empty:
        print(f"\nChico Beto: Como num achei '{nome_produto_foco}' aqui no estoque, vou anotar pra gente num esquec√™ de mercar depois, t√°?")
        salvar_faltantes_na_planilha(nome_produto_foco)


# 7. Loop de intera√ß√£o com o cliente
def iniciar_conversa_chico():
    print("\n========================================================")
    print("Chico Beto: Ol√°, cumpadi! Sou o Chico Beto, seu mi√≥ assistente nas hora das compra!")
    print("Chico Beto: Pode pergunt√° o que precis√° que eu dou um jeito de ajud√° ou orient√°, t√° bom?")
    print("Chico Beto: Se quis√© encerr√° a prosa, √© s√≥ fal√° 'sair', 'tchau' ou 'n√£o, obrigado'.")
    print("========================================================")

    if df.empty:
        return

    if not GOOGLE_API_KEY:
        return

    while True:
        entrada_usuario = input("\nVoc√™: ").strip()

        if not entrada_usuario:
            continue

        palavras_de_saida = ["sair", "tchau", "nada", "n√£o", "nao", "obrigado", "xau", "ate mais", "at√© mais", "brigado"]
        if any(palavra_saida in entrada_usuario.lower() for palavra_saida in palavras_de_saida):
            print("Chico Beto: Int√© mais ver ent√£o, cumpadi! Fico feliz√£o de ajud√° e amo ser seu assistente aqui. Vorta sempre que precis√°, viu?!")
            break

        consultar_produto_chico(entrada_usuario)
        print("\nChico Beto: Precisa de mais alguma coisa, cumpadi?")

# Inicia a conversa quando o script √© executado
if __name__ == '__main__':
    iniciar_conversa_chico()
